version: '3.8'

services:
  gluetun:
    image: qmcgaw/gluetun:latest
    container_name: gluetun
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    ports:
      - "43211:43211"  # Seanime
      - "8085:8085"    # qBittorrent
    volumes:
      - /aeternae/configurations/animechanica/mullvad:/gluetun/mullvad:Z
    environment:
      # VPN settings
      - VPN_SERVICE_PROVIDER=mullvad
      - VPN_TYPE=openvpn
      - OPENVPN_USER_FILE=/gluetun/mullvad/mullvad_userpass.txt
      - SERVER_COUNTRIES=Switzerland
      - SERVER_CITIES=Zurich
      
      # Kill switch and firewall settings
      - FIREWALL=on
      - FIREWALL_OUTBOUND_SUBNETS=192.168.0.0/16,172.16.0.0/12,10.0.0.0/8
      
      # DNS settings for faster resolution
      - DOT=off
      - DNS_KEEP_NAMESERVER=off
      - DNS_ADDRESS=1.1.1.1
      
      # Performance optimizations
      - OPENVPN_FLAGS=--fast-io --tun-mtu 1500 --fragment 1300 --mssfix 1200
      - LOG_LEVEL=info
      
      # Timezone
      - TZ=America/Los_Angeles
      
      # Health check settings (reduced frequency for less overhead)
      - HEALTH_VPN_DURATION_INITIAL=60s
      - HEALTH_VPN_DURATION_ADDITION=30s
    restart: unless-stopped
    security_opt:
      - label=type:container_runtime_t
    sysctls:
      - net.ipv6.conf.all.disable_ipv6=1
    ulimits:
      nofile:
        soft: 65536
        hard: 65536

  seanime:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: seanime
    depends_on:
      - gluetun
    network_mode: "service:gluetun"
    volumes:
      - /aeternae/configurations/animechanica/data:/data:Z
      - /aeternae/theater/anime/completed/:/media/anime:Z
      - /aeternae/theater/dl_anime/:/media/dl_anime:Z
      - /aeternae/library/dl_manga/:/media/dl_manga:Z
      - /aeternae/configurations/animechanica/qbittorrent:/root/.config/qBittorrent:Z
    environment:
      - TZ=America/Los_Angeles
      - SKIP_VPN_SETUP=true  # Skip VPN setup since Gluetun handles it
      # Performance optimizations
      - GOMAXPROCS=0
      - GOMEMLIMIT=1GiB
    restart: unless-stopped
    security_opt:
      - label=type:container_runtime_t
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
